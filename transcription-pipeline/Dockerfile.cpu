# CPU-based transcription pipeline with working diarization
FROM python:3.9-slim

ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /workspace

# Install system dependencies
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1 \
    git \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies with specific versions for compatibility
RUN pip install --upgrade pip wheel

# Install in specific order to avoid conflicts
RUN pip install torch==2.0.1 torchaudio==2.0.2 --index-url https://download.pytorch.org/whl/cpu
RUN pip install faster-whisper==0.7.1
RUN pip install pyannote.audio==3.1.1

# Install other dependencies
RUN pip install \
    librosa==0.10.1 \
    soundfile==0.12.1 \
    numpy==1.24.3 \
    scipy>=1.7.0 \
    tqdm>=4.60.0 \
    pyyaml>=6.0 \
    psutil>=5.8.0

# Copy application files
COPY src/ ./src/
COPY config/ ./config/
COPY scripts/ ./scripts/

# Modify script for CPU
RUN sed -i 's/device="cuda"/device="cpu"/g' /workspace/scripts/transcribe_pipeline.py && \
    sed -i 's/compute_type="float16"/compute_type="int8"/g' /workspace/scripts/transcribe_pipeline.py

RUN chmod +x scripts/*.py
RUN mkdir -p /workspace/models

# Set CPU-only environment
ENV CUDA_VISIBLE_DEVICES=""

ENTRYPOINT ["python", "scripts/transcribe_pipeline.py"]
CMD ["--help"]